---
// Astro frontmatter
import Layout from "@/layouts/Layout.astro";
import Header from "@/components/Header.astro";
import Footer from "@/components/Footer.astro";
import fs from "fs";
import path from "path";

import Main from "@/layouts/Main.astro";
const albumDir = path.resolve("public/assets/gallery");

type Album = {
  name: string;
  cover: string | null;
};

let albums: Album[] = [];

if (fs.existsSync(albumDir)) {
  const folderNames = fs.readdirSync(albumDir).filter((name) => {
    const fullPath = path.join(albumDir, name);
    return fs.statSync(fullPath).isDirectory();
  });

  albums = folderNames.map((folder) => {
    const folderPath = path.join(albumDir, folder);
    const files = fs.readdirSync(folderPath).filter((f) =>
      /\.(jpe?g|png|webp|gif)$/i.test(f)
    );

    // ä¼˜å…ˆä½¿ç”¨ cover.jpegï¼ˆå¿½ç•¥å¤§å°å†™ï¼‰
    const coverFile = files.find((f) => f.toLowerCase() === "cover.jpeg");

    const coverImage = coverFile
      ? `/assets/gallery/${folder}/${coverFile}`
      : files.length > 0
        ? `/assets/gallery/${folder}/${files.sort()[0]}`
        : null;

    return {
      name: folder,
      cover: coverImage,
    };
  });
}
---

<Layout>
  <Header />

  <Main pageTitle="ğŸ“ Gallery" pageDesc="A visual archive of places Iâ€™ve explored and captured.">
    {albums.length === 0 ? (
      <p class="text-gray-500 italic">æš‚æ— ç›¸å†Œï¼Œå¿«å»æ—…è¡Œå§ï¼ğŸŒ</p>
    ) : (
      <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
        {albums.map(({ name, cover }) => (
          <a
            href={`/gallery/${name}`}
            class="block bg-gray-100 rounded shadow hover:bg-gray-200 transition overflow-hidden"
          >
            {cover && (
              <img
                src={cover}
                alt={`å°é¢ - ${name}`}
                class="w-full h-48 object-cover"
              />
            )}
            <div class="p-4">
              <h2 class="text-xl font-semibold capitalize">{name}</h2>
              <p class="text-sm text-gray-600">View &rarr;</p>
            </div>
          </a>
        ))}
      </div>
    )}
  </Main>

  <Footer />
</Layout>
